{% extends "layout/base.html" %}
{% load finance_extras %}
{% block content %}
<div class="d-flex align-items-center mb-3">
  <div>
    <h2 class="page-title">Detalhamento de Lancamentos</h2>
    <div class="text-muted">Auditoria por {{ rotulo_evento_singular|lower }} atual</div>
  </div>
  <div class="ms-auto">
    <button class="btn btn-outline" type="button" onclick="window.print()">Imprimir</button>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Data inicio</label>
        <input class="form-control" type="date" name="data_inicio" value="{{ filtros.data_inicio }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Data fim</label>
        <input class="form-control" type="date" name="data_fim" value="{{ filtros.data_fim }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Tipo</label>
        <select class="form-select" name="tipo" id="filtro_tipo">
          <option value="">Todos</option>
          <option value="RECEITA" {% if filtros.tipo == 'RECEITA' %}selected{% endif %}>Receita</option>
          <option value="DESPESA" {% if filtros.tipo == 'DESPESA' %}selected{% endif %}>Despesa</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Categoria</label>
        <select class="form-select" name="categoria" id="filtro_categoria">
          <option value="">Todas</option>
          {% for categoria in categorias %}
            <option value="{{ categoria.id }}" {% if filtros.categoria == categoria.id|stringformat:'s' %}selected{% endif %}>{{ categoria.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Conta</label>
        <select class="form-select" name="conta">
          <option value="">Todas</option>
          {% for conta in contas %}
            <option value="{{ conta.id }}" {% if filtros.conta == conta.id|stringformat:'s' %}selected{% endif %}>{{ conta.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Forma</label>
        <select class="form-select" name="forma_pagamento">
          <option value="">Todas</option>
          {% for code, label in formas_pagamento %}
            <option value="{{ code }}" {% if filtros.forma_pagamento == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8">
        <label class="form-label">Descricao</label>
        <input class="form-control" type="text" name="texto" placeholder="Busca por descricao" value="{{ filtros.texto }}">
      </div>
      <div class="col-md-4 text-end" style="margin-top: 28px;">
        <button class="btn btn-secondary" type="submit">Filtrar</button>
        <a class="btn btn-outline" href="{% url 'finance:relatorio_detalhado' %}">Limpar</a>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table card-table table-vcenter">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Categoria</th>
          <th>Conta</th>
          <th>Forma</th>
          <th class="text-end">Valor</th>
          <th>Descricao</th>
          <th>Usuario</th>
          <th>Anexos</th>
        </tr>
      </thead>
      <tbody>
        {% for lancamento in page_obj %}
          <tr>
            <td>{{ lancamento.data }}</td>
            <td>{{ lancamento.get_tipo_display }}</td>
            <td>{{ lancamento.categoria.nome }}</td>
            <td>{{ lancamento.conta.nome }}</td>
            <td>{{ lancamento.get_forma_pagamento_display }}</td>
            <td class="text-end">{{ lancamento.valor|brl }}</td>
            <td>{{ lancamento.descricao }}</td>
            <td>{{ lancamento.criado_por }}<br><small>{{ lancamento.criado_em }}</small></td>
            <td>
              {% if lancamento.qtd_anexos %}
                {% if pode_anexos %}
                  <a href="{% url 'finance:anexos' lancamento.id %}" class="btn btn-sm">{{ lancamento.qtd_anexos }}</a>
                {% else %}
                  {{ lancamento.qtd_anexos }}
                {% endif %}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="9">Nenhum lancamento encontrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card-body">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li><a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a></li>
      {% endif %}
      {% for page in page_obj.paginator.page_range %}
        <li class="{% if page_obj.number == page %}active{% endif %}">
          <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page }}">{{ page }}</a>
        </li>
      {% endfor %}
      {% if page_obj.has_next %}
        <li><a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Proxima</a></li>
      {% endif %}
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  @media print {
    .navbar, .navbar-vertical, .card.mb-3, .btn { display: none !important; }
    .page-wrapper { margin: 0; }
  }
</style>
<script>
  (function () {
    const tipoSelect = document.getElementById('filtro_tipo');
    const categoriaSelect = document.getElementById('filtro_categoria');

    if (!tipoSelect || !categoriaSelect) return;

    async function filtrarCategorias() {
      const tipo = tipoSelect.value;
      const selected = categoriaSelect.value;
      try {
        const response = await fetch(`{% url 'finance:categorias_por_tipo' %}?tipo=${encodeURIComponent(tipo)}`);
        const data = await response.json();
        categoriaSelect.innerHTML = '<option value="">Todas</option>';
        data.categorias.forEach((categoria) => {
          const opt = document.createElement('option');
          opt.value = categoria.id;
          opt.textContent = categoria.nome;
          if (String(categoria.id) === String(selected)) {
            opt.selected = true;
          }
          categoriaSelect.appendChild(opt);
        });
      } catch (err) {
        // fallback: keep current options on error
      }
    }

    tipoSelect.addEventListener('change', filtrarCategorias);
    filtrarCategorias();
  })();
</script>
{% endblock %}
